---
  title: 'Report on Myositis exploration on IMD basis '
author: "Guillermo Reales"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
  toc: true
toc_float: true
fig_caption: yes

---
  
----
  
# Background
  
  We want to learn more about myositis and its subtypes in the light of IMD. For that we'll take a look at myositis projections from two studies (Miller et al., 2015 and Rothwell et al. 2022) together with our other IMD projected.



```{r include=FALSE, warning=FALSE, message=F}

# Load packages
library(data.table)
library(magrittr)
library(rmeta)
library(ggplot2)
library(cowplot)
library(pheatmap)
library(reshape2)
library(knitr)
library(kableExtra)
library(ggrepel)

# Load files

m <- fread("../data/Metadata_20230503-v1.tsv")
m <- m[, .(Trait, First_Author, Reference, Trait_ID_2.0, Trait_long, Trait_class, N0, N1, N, Population, Public)]

q <- fread("../data/QC_IMD_basis_20230503-v1.tsv")
q <- merge(q, m, by="Trait")

p <- fread("../data/Projection_IMD_basis_20230503-v1.tsv")
p[, Var.Delta:=as.numeric(Var.Delta)]
b <- p[1:169] # Basis traits
p <- p[179:nrow(p)] # projection table without basis traits
p[, z:=NULL]



### (1) QC
SNP.manifest <- cupcake::SNP.manifest

# Checking missing projections
summary(q)
q[is.na(q$overall_p)] 
# MDD_Wray_2, Major depression disorder, that failed to project by low SNP match.
# T2D_Gaulton 
q <- q[!is.na(q$overall_p)] # Remove datasets with missing overall p-values


# Check SNP match
c(lessthan95 = nrow(q[q$nSNP < nrow(SNP.manifest)*.95,]), lessthan80 = nrow(q[q$nSNP < nrow(SNP.manifest)*.8,]), lessthan50 = nrow(q[q$nSNP < nrow(SNP.manifest)*.5,]))
c(lessthan95 = nrow(q[q$nSNP < nrow(SNP.manifest)*.95,])/nrow(q), lessthan80 = nrow(q[q$nSNP < nrow(SNP.manifest)*.8,])/nrow(q), lessthan50 = nrow(q[q$nSNP < nrow(SNP.manifest)*.5,])/nrow(q))
# 4% of datasets (248) have <80% SNP match

# Dataset filtering

# This is a crucial point.
# As we have many datasets, many of them redundant or not so interesting for our purposes, and the set of datasets included in the adjustment will influence the resulting set of overall significant datasets, so we must choose carefully which datasets we remove *before* performing the FDR adjustment on the next step.
# 
# At this step, we'll:
# 
# 1. Focus on files that came from a Genome-wide array (ie. not Immunochip), and have at least **80%** of matching SNPs, so we can have confidence in our observations.
# 2. Remove basis datasets
# 3. Remove Neale, as we already have PanUKBBR2
# 4. Apply FDR procedure

# 1. Remove datasets with <80% SNP match. This will include datasets using targeted arrays only (ie. ImmunoChip). Keep Deakin's JDM for its interest
qf <- q[nSNP >= max(nSNP) * 0.8 ]

# 2. Remove basis datasets
basis.datasets <- c("CD_DeLange_28067908_1", "PSC_Ji_27992413_1", "UC_DeLange_28067908_1", "SLE_Bentham_26502338_1", "PBC_Cordell_26394269_1", "IGAN_Kiryluk_25305756_1", "CEL_Dubois_20190752_1", "MS_IMSGC_21833088_1", "AST_Demenais_29273806_1", "VIT_Jin_27723757_1", "RA_Okada_24390342_1", "LADA_Cousminer_30254083_1", "T1D_Cooper_doi101101120022_1")
#Also, remove datasets used to build the IMD basis, which are overfitted
qf <- qf[!Trait %in% basis.datasets]

# 3. Remove Neale, as we already have PanUKBBR2
qf <- qf[First_Author != "Neale"]


# Check traits by class
table(qf$Trait_class)
# Create filtered projection table too
pf <- merge(p, qf[,c("First_Author","Trait", "Trait_ID_2.0", "Trait_long","Trait_class", "Population")], by = "Trait")

# We'll meta-analyse the myositis projections prior to moving forward

```


# Meta-analysing myositis and polymyositis datasets

We've experienced problems derived from lack of power in myositis datasets. To try and overcome this issue, we'll meta-analyse some projections from which we have independent data. 

Miller and Rothwell are not independent, so we'll meta-analyse Myositis (FinnGen + Miller) and Polymyositis (FinnGen + Miller).


```{r echo= FALSE}

myo.sel <-  pf[grepl("^Myositis", Trait_long, ignore.case = TRUE ) & First_Author %in% c("Miller", "FinnGen"), unique(Trait)]
pm.sel <- pf[grepl("^Polymyositis", Trait_long, ignore.case = TRUE ) & First_Author %in% c("Miller", "FinnGen"), unique(Trait)]

p.myo <- pf[Trait %in% myo.sel]
p.pm <- pf[Trait %in% pm.sel]

meta.proj <- function(ds){
        mincol <- c("PC","Delta","Var.Delta","P","Trait")
        stopifnot(all(mincol %in% names(ds)))
        res <- lapply(unique(ds$PC), function(x){
                p1ms <- ds[PC == x]
                p1ms.r <- meta.summaries(p1ms$Delta, sqrt(p1ms$Var.Delta), names= p1ms$Trait, method="fixed")
                p1ms.r <- data.table(PC = x, Delta = p1ms.r$summary, Var.Delta = p1ms.r$se.summary^2, chisq_het = p1ms.r$het[1], df_het = p1ms.r$het[2],  P_het = p1ms.r$het[3]) 
                p1ms.r[, Z:=Delta/sqrt(Var.Delta)]
                p1ms.r <- p1ms.r[, .(PC, Delta, Var.Delta,Z, chisq_het, df_het, P_het)]
        })
        res <- rbindlist(res)
}

meta.myo <- meta.proj(p.myo)
meta.myo[, c("Trait", "Trait_long"):="Myositis"]
meta.pm <- meta.proj(p.pm)
meta.pm[, c("Trait", "Trait_long"):="Polymyositis"]

meta.all <- rbindlist(list(meta.myo, meta.pm))
meta.all[, P:=stats::pnorm(abs(Z), lower.tail = FALSE) * 2] 
meta.all[, c("chisq_het", "df_het", "P_het", "Z"):=NULL]
meta.all[, First_Author:= "Miller + FinnGen"][, Trait_class:="IMD"]

# Get Rothwell too for comparison
roth <- pf[grepl("Myositis\\)|^Polymyositis", Trait_long) & First_Author == "Rothwell", unique(Trait)]

ind.myo <- pf[Trait %in% c(myo.sel, pm.sel, roth)]
deltamyo <- rbindlist(list(meta.all, ind.myo), fill=TRUE)
deltamyo[Trait_ID_2.0=="IIM", Trait_long:="Myositis"][, Trait_long:=sub(" \\(FinnGen\\)", "", Trait_long)]

# Add ci for deltaplots
deltamyo[, ci:=sqrt(Var.Delta) * 1.96]

dplot.myo <- function(ds, pc){
  ds1 <- ds[get("PC") == paste0("PC", pc)]
  d1p <- ggplot(ds1, aes(x=Delta, y = First_Author, xmin=Delta-ci, xmax=Delta+ci, colour = First_Author))+
          geom_pointrange()+
          geom_vline(xintercept = 0, col="red", lty=2)+
          xlab("Delta")+
          ggtitle(paste0("PC", pc))+
          facet_grid(Trait_long~., scales = "free", space = "free", switch = "y")+
          theme_cowplot(8)+
          theme(legend.position = "none", strip.text.y.left = element_text(angle = 0), axis.title.y = element_blank(), plot.title = element_text(size = 8))
    d1p
}

myoplots <- lapply(c(1:3, 8:9, 13), function(x){
            dplot.myo(deltamyo, x)
    })

gmp.plot <- plot_grid(plotlist = myoplots,scale = 0.95, ncol=2, labels = NULL)
#ggsave("../figures/Myo_polymyo_meta_deltaplots.png", width =6, height = 7, bg="white")
gmp.plot

```


# Exploratory data analysis

Next we analysed our myositis datasets in the context of meta-analyses and the rest of projections, with a focus on IMD. We applied our routine quality control to our collection of projections, applied an FDR procedure to keep datasets that are (1) significantly different from zero overall (FDR < 1%) and (2) by PC (FDR < 1% [●] or FDR < 5% [○]). 


```{r include=FALSE}

# pf <- pf[!Trait %in% c(myo.sel, pm.sel)]
# pf <- rbindlist(list(pf, meta.all), fill = TRUE)
# pf[, FDR.PC:=p.adjust(P, method = "BH"), by = c("PC", "Trait_class")][, stars:=ifelse(!is.na(FDR.PC) & FDR.PC<0.05,"○","")][ FDR.PC < 0.01 , stars:="●"]
# ps <- pfm[Trait %in% c(ttk2, unique(meta.all$Trait))] # keep non-redundant traits and meta-analyses

# 4. Apply FDR procedure

# Remove datasets that were included in the meta-analyses
qf <- qf[!Trait %in% c(myo.sel, pm.sel)]

# Apply 1% FDR correction to overall p for all remaining datasets
qf[, FDR.overall := p.adjust(overall_p, method = "BH"), by="Trait_class"]

tsig <- copy(qf)
tsig[, sig.overall:=ifelse(FDR.overall < 0.01, "Y", "N")]
table(tsig$sig.overall)
#    N     Y 
#  4800  854

qs <- qf[FDR.overall < 0.01]
nrow(qs) / nrow(qf)
# 15% significant
table(qs$Trait_class) / nrow(qs)
# 16.5% Blood cells
# 35.9% IMD

table(qs$Trait_class)
#  BC BMK CAN IMD INF OTH PSD 
# 142  72  17 309  35 282   2 

# Which myositis datasets didn't make the cut?
qf[grepl("myositis", Trait_long, ignore.case = TRUE) & !Trait %in% qs$Trait]
# 6 datasets. These include:
#    First_Author       Trait_ID_2.0                                 Trait_long 
# 1:      PanUKBB         20002_1322                   Myositis/Myopathy (UKBB) 
# 2:     Rothwell                IBM                    Inclusion Body Myositis 
# 3:      FinnGen   M13_DERMATOMYOTH            Other dermatomyositis (FinnGen) 
# 4:      FinnGen M13_DERMATOPOLYNAS Dermatopolymyositis, unspecified (FinnGen) 
# 5:       Sakaue                 PM                               Polymyositis 
# 6:      PanUKBB              ph770    Myalgia and myositis unspecified (UKBB) 

# Apply 5% FDR correction by trait and PC to projections, then filter by overall significant traits
# NOTE: Here we'll do something different. As meta-analyses don't come with overall_p, 
# we'll consider them significant overall, for their interest.

pf <- pf[!Trait %in% c(myo.sel, pm.sel)]
pf <- rbindlist(list(pf, meta.all), fill = TRUE)
pf[, FDR.PC:=p.adjust(P, method = "BH"), by = c("PC", "Trait_class")][, stars:=ifelse(!is.na(FDR.PC) & FDR.PC<0.05,"○","")][ FDR.PC < 0.01 , stars:="●"]
# Filter pf by overall significant traits
ps <- pf[Trait %in% qs$Trait | First_Author == "Miller + FinnGen"]
ps[, PC:=factor(PC, levels = paste0("PC", 1:13))]


# (3) Learn about myositis position onto the basis

ps[grepl("myositis", Trait_long, ignore.case = TRUE) & FDR.PC < 0.01, .(PC, First_Author, Trait_long, FDR.PC, stars)][order(PC)]
# We have some significant Myositis for PC1, 2, 3, 8, 9, 12, and 13

# Let's try to remove redundant datasets in a less manual way
qs2 <- copy(qs)
qs2 <- qs2[Trait_class == "IMD"] # Interested in IMDs for now
qs2[,Label:=Trait_long] %>% .[!grepl("myositis", Trait_long, ignore.case = TRUE), Label:=gsub(" \\(UKBB\\)", "", Label)] %>% .[!grepl("myositis", Trait_long, ignore.case = TRUE) , Label:=gsub(" \\(FinnGen\\)", "", Label)] %>% .[, Label:=gsub(" \\(FG\\)", "", Label)] # Remove UKBB/FinnGen stuff save for myositis datasets


# There are a number of duplicated diseases that we can revisit
# CD
qs2[grepl("Crohn|Chron", Label)][order(N1, decreasing = TRUE)]
tr <- c(setdiff(qs2[grepl("Crohn|Chron", Label), Trait], "CD_Liu_26192919_1")) # We select CD Liu, exclude the rest

# UC
qs2[grepl("colitis|UC |Ulcerative", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("colitis|UC |Ulcerative", Label), Trait], "UC_Liu_26192919_1")) # We select UC Liu, exclude the rest

# IBD
qs2[grepl("bowel|IBD ", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("bowel|IBD ", Label, ignore.case = TRUE), Trait], "IBD_Liu_26192919_1")) #  There's a larger, DeLange IBD, but we stick with Liu for consistency

# T1D
qs2[grepl("Type 1 diabetes|Type1", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Type 1 diabetes|Type1", Label, ignore.case = TRUE), Trait], "T1D_Chiou_34012112_1"))

# Asthma
qs2[grepl("Asthma", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Asthma", Label, ignore.case = TRUE), Trait], c("ph495_PanUKBB_PanUKBBR2_1", "ASTAO_Ferreira_30929738_1", "ASTCO_Ferreira_30929738_1")))

# COPD
qs2[grepl("COPD|chronic obstructive", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("COPD|chronic obstructive", Label, ignore.case = TRUE), Trait], "J10_COPD"))

# (Rheumatoid) Arthritis
qs2[grepl("Arthritis", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Arthritis", Label, ignore.case = TRUE), Trait], c("RA_Ishigaki_36333501_3", "JIA_LopezIsac_33106285_1")))

# Hypothyroidism
qs2[grepl("Hypothyroidism", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Hypothyroidism", Label, ignore.case = TRUE), Trait], c("HYPOTHYROIDISM_FinnGen_FinnGenR7_1")))

# Psoriasis
qs2[grepl("Psoria", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Psoria", Label, ignore.case = TRUE), Trait], c("L12_PSORIASIS_FinnGen_FinnGenR7_1", "L12_PSORI_ARTHRO_FinnGen_FinnGenR7_1")))

# Graves' disease
qs2[grepl("Graves", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Graves", Label, ignore.case = TRUE), Trait], c("E4_GRAVES_STRICT_FinnGen_FinnGenR7_1")))

# Diabetic related stuff
qs2[grepl("Diabetic|Diabetes[, ]", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Diabetic|Diabetes[, ]", Label, ignore.case = TRUE), Trait], c("DM_RETINOPATHY_FinnGen_FinnGenR7_1", "DM_NEPHROPATHY_FinnGen_FinnGenR7_1")))

# Dermatitis
qs2[grepl("Dermatitis", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Dermatitis", Label, ignore.case = TRUE), Trait], c("ATD_Paternoster_26482879_1")))

# Sjogren
qs2[grepl("Sjogren|Sjögren|Sicca", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Sjogren|Sjögren|Sicca", Label, ignore.case = TRUE), Trait], c("SJOS_Lessard_up_1")))

# Lupus
qs2[grepl("Lupus|SLE", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("Lupus|SLE", Label, ignore.case = TRUE), Trait], c("SLE_Julia_29848360_1")))

# Allergic
qs2[grepl("allerg", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("allerg", Label, ignore.case = TRUE), Trait], c("20002_1387_PanUKBB_PanUKBBR2_1")))

# Multiple sclerosis
qs2[grepl("multiple sclerosis", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("multiple sclerosis", Label, ignore.case = TRUE), Trait], c("G6_MS_FinnGen_FinnGenR7_1"))) # largest, non-IMSGC dataset


# Nasal polyps
qs2[grepl("polyp", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("polyp", Label, ignore.case = TRUE), Trait], c("J10_NASALPOLYP_FinnGen_FinnGenR7_1")))

# PBC
qs2[grepl("biliary", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("biliary", Label, ignore.case = TRUE), Trait], c("CHIRBIL_PRIM_FinnGen_FinnGenR7_1")))

# PSC
qs2[grepl("sclerosing", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("sclerosing", Label, ignore.case = TRUE), Trait], c("K11_CHOLANGI_FinnGen_FinnGenR7_1")))

# Systemic sclerosis
qs2[grepl("systemic sclerosis", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("systemic sclerosis", Label, ignore.case = TRUE), Trait], c("SSC_LopezIsac_31672989_1")))

# Autoimmune disorders
tr <- c(tr, qs2[grepl("autoimmune dis", Label, ignore.case = TRUE), Trait]) 

# Celiac disease
qs2[grepl("celiac|coeliac", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("celiac|coeliac", Label, ignore.case = TRUE), Trait], c("K11_COELIAC_FinnGen_FinnGenR7_1")))

# Gout and ankylosing
qs2[grepl("gout|ankylosing", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("gout|ankylosing", Label, ignore.case = TRUE), Trait], c("GOUT_FinnGen_FinnGenR7_1", "M13_ANKYLOSPON_FinnGen_FinnGenR7_1")))

# Vitiligo
qs2[grepl("vitiligo", Label, ignore.case = TRUE)][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[grepl("vitiligo", Label, ignore.case = TRUE), Trait], c("L12_VITILIGO_FinnGen_FinnGenR7_1")))

# Myastenia gravis
qs2[Label == "Myastenia Gravis"][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[Label == "Myastenia Gravis" , Trait], c("MYG_Chia_35074870_1")))

# Thyroiditis
qs2[Label == "Thyroiditis"][order(N1, decreasing = TRUE)]
tr <- c(tr, setdiff(qs2[Label == "Thyroiditis" , Trait], c("THYROIDITIS_FinnGen_FinnGenR7_1")))

# There was an extra DMPMYO by FinnGen, we'll remove it
tr <- c(tr, "DERMATOPOLY_FG_FinnGen_FinnGenR7_1")

qs2 <- qs2[!Trait %in% tr] # First pass
length(unique(qs2$Label))

# Check for duplicates, if there are still
dp <- qs2[duplicated(Label), unique(Label)]
qsdup <- qs2[Label %in% dp]

# Rename Rothwell myositis to fit the rest
qs2[ First_Author == "Rothwell", Label:=gsub("Idiopathic Inflammatory Myopathies \\(IIM, Myositis\\)", "Myositis", Label)]

# Show authors for myositis
qs2[First_Author %in% c("Rothwell", "Miller"), Label:=paste0(Label, " (", First_Author, ")")] # Now there shouldn't be any duplicates
qs2[Label == "MS-disease \\/ Multiple Sclerosis \\(FinnGen\\)"] # 
qs2[grepl("MS", Label), Label:="Multiple Sclerosis"] # Fix weird FinnGen MS label

# Check for duplicates, if there are still
dp <- qs2[duplicated(Label), unique(Label)]
qsdup <- qs2[Label %in% dp]

# Apply this to projections as well
ttk2 <- qs2$Trait # Traits to keep
ps2 <- ps[Trait %in% ttk2 | First_Author == "Miller + FinnGen"]
# Incorporate labels
ps2 <- merge(ps2, qs2[, .(Trait, Label)], by="Trait", all.x = TRUE)
ps2[First_Author == "Miller + FinnGen" , label:=paste0(Trait, " (Meta-analysis)")] # Give meta-analyses a proper label
ps2[, PC:=factor(PC, levels = paste0("PC", 1:13))]

```


Next:

* HeatMap with all other traits
* Mahalanobis tables and heatmaps
* DPMUnc with meta-analysis data
* Clean stuff from old analyses.


