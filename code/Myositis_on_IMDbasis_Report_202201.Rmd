---
title: "Myositis on the IMD basis"
author: "Guillermo Reales"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
  pdf_document: default
---


---


# Background


---

We're trying to learn more about myositis and its subtypes by projecting summary data onto our IMD basis.

This report will aim to explore myositis projections and generate figures for the paper.


---


# Exploratory Data Analysis


---

First, let's load the required libraries and files.

```{r warning=FALSE}
library(cupcake)
library(data.table)
library(magrittr)
library(pheatmap)
library(reshape2)
library(ggplot2)
library(cowplot)
library(ggrepel)
library(gridExtra)
library(stringr)
library(purrr)
#library(chromoMap)


# Define some helper functions
make.labels <- function(x){
  x[,Label:=Trait_long] %>% 
    .[, Label:=gsub(" \\(UKBB\\)", "", Label)] %>% 
    .[, Label:=gsub(" \\(FinnGen\\)", "", Label)] %>% 
    .[, Label:=gsub(" \\(FG\\)", "", Label)] %>% 
    .[, Label:=gsub("Crohn disease \\(strict definition, all UC cases excluded\\)", "Crohn's, strict", Label)] %>% 
    .[, Label:=gsub("Eosinophilic Granulomatosis with Polyangiitis", "EGPA", Label)] %>% 
    .[ First_Author == "FinnGen", Label:=paste0(str_trunc(Label, width = 50), " / ", First_Author)] %>% 
    .[ First_Author != "FinnGen", Label:=paste0(str_trunc(paste0(Label, " (", Population,")"), width = 50), " / ", First_Author)] %>% 
    .[, Label:=gsub("Neale", "UKBB", Label)] %>% 
    .[, Label:=gsub("PanUKBB", "UKBB", Label)] # Addition to accommodate PanUKBB
  
}

# Since we have MANY datasets, we use an accessory function to highlight the myositis datasets. Fromhttps://github.com/raivokolde/pheatmap/issues/48
# use this function to make row or column names bold
# parameters:
#   mat: the matrix passed to pheatmap
#   rc_fun: either rownames or colnames
#   rc_names: vector of names that should appear in boldface
make_bold_names <- function(mat, rc_fun, rc_names) {
  bold_names <- rc_fun(mat)
  ids <- rc_names %>% match(rc_fun(mat))
  ids %>%
    walk(
      function(i)
        bold_names[i] <<-
        bquote(bold(.(rc_fun(mat)[i]))) %>%
        as.expression()
    )
  bold_names
}


save_pheatmap_png <- function(x, filename, width=1200, height=1000, res = 150) {
  png(filename, width = width, height = height, res = res)
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}

save_pheatmap_svg <- function(x, filename, width=16, height=16) { 
  svg(filename, width = width, height = height, bg = "white", ) # Warning: Size in inches, can't change it to pixels
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}


# Load data
proj.table <- fread("../data/Projection_IMD_basis_20211220-v1.tsv")
QC.table <- fread("../data/QC_IMD_basis_20211220-v1.tsv")
metadata <- fread("../data/Metadata_20220112-v1.tsv")
QC.table <- merge.data.table(QC.table, metadata) # Keep only datasets present in metadata, too. We hadn't added SJOS_Lessard back then, so we'll not consider it.

manifest.translator <- fread("../data/Manifest_build_translator.tsv")
manifest.translator[,pid19:=paste(CHR19, BP19, sep = ":")][, pid38:=paste(CHR38, BP38, sep = ":")]
manifest.translator <- manifest.translator[,c(1,8:9)]
SNP.manifest <- merge(manifest.translator, copy(cupcake::SNP.manifest), by.x = "pid19", by.y = "pid")

# Extract basis projections for later
PT.basis <- copy(cupcake::basis.trait.proj)
setnames(PT.basis, c("delta", "trait"), c("Delta", "Label"))
PT.basis[,proj:=NULL][, stars:=""][, c("Var.Delta", "z", "P") := NULL]

```

**Note:** Datasets are in **hg38** while the basis was built in **hg19**. Thus, we'll need to use a "translator" to extract relevant information from the basis SNP manifest.


------------------------------------------------------------------------

# Quality control

------------------------------------------------------------------------

## Checking matching SNPs


For the projected datasets, we see how many, and what proportion of all files have less than 95%, 80%, and 50% of matching SNPs, respectively

```{r}
QC.table <- QC.table[!is.na(QC.table$overall_p),]

c(lessthan95 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.95,]), lessthan80 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.8,]), lessthan50 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.5,]))
c(lessthan95 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.95,])/nrow(QC.table), lessthan80 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.8,])/nrow(QC.table), lessthan50 = nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.5,])/nrow(QC.table))

```

Only `r (nrow(QC.table[QC.table$nSNP < nrow(SNP.manifest)*.8,])/nrow(QC.table)) * 100`% of datasets have below 80% match.


## Prepare data for visualisation (remove datasets, apply FDR threshold and select datasets)

We'll now select the datasets that we'll include in the analysis, correct for multiple testing (FDR 1% overall + **FDR 5%** PC), and select the datasets we'll use for visualisation.

```{r}

# Note HBC_Chen_6  have some issues that I couldn't resolve so far, so I'll exclude them
## EOSC_Chen_3 used to have some problems in the blood cell basis, but we'll keep it
##### & Trait!="EOSC_Chen_32888493_3"

QC.table <- QC.table[!Trait %in% c("HBC_Chen_32888493_6")]
proj.table <- proj.table[!Trait %in% c("HBC_Chen_32888493_6")]

# Remove datasets with low (<80%) SNP coverage and Immunochip, except for Rothwell, which is myositis but is imputed.
# Remove datasets with <80% SNP match
# Remove remove datasets used to build the IMD basis, which are overfitted
basis.datasets <- c("CD_DeLange_28067908_1", "PSC_Ji_27992413_1", "UC_DeLange_28067908_1", "SLE_Bentham_26502338_1", "PBC_Cordell_26394269_1", "IGAN_Kiryluk_25305756_1", "CEL_Dubois_20190752_1", "MS_IMSGC_21833088_1", "AST_Demenais_29273806_1", "VIT_Jin_27723757_1", "RA_Okada_24390342_1", "LADA_Cousminer_30254083_1", "T1D_Cooper_doi101101120022_1")

QC.filt <- QC.table[nSNP >= max(nSNP) * 0.8 ][!Trait %in% basis.datasets][First_Author == "Rothwell"  | !grepl("ImmunoChip", Chip, ignore.case = TRUE)]

# Check number of datasets per category.
table(QC.filt$Trait_class)

# Create filtered projection table too. 
PT.filt <- merge(proj.table, QC.filt[,c("First_Author","Trait", "Trait_ID_2.0", "Trait_long","Trait_class", "Collection", "Population")], by = "Trait")

# Apply 1% FDR correction to overall p for all remaining datasets
QC.filt[, FDR.overall := p.adjust(overall_p, method = "BH"), by="Trait_class"]
QC.sig <- QC.filt[FDR.overall < 0.01,]
table(QC.sig$Trait_class)

# Apply 5% FDR correction by trait and PC to projections, then filter by overall significant traits
PT.filt[, FDR.PC:=p.adjust(P, method = "BH"), by = c("PC", "Trait_class")][, stars:=ifelse(!is.na(FDR.PC) & FDR.PC<0.05,"○","")][ FDR.PC < 0.01 , stars:="●"] ### Change here significance thresholds for the figure!
# ◑ Alternative
# • Original significant
# Filter PT.filt by overall significant traits
PT.sig <- PT.filt[Trait %in% QC.sig$Trait,]
```


All Myositis datasets got significant projections for the IMD basis, except for IBM (Inclusion Body Myositis).


---


# Visualising projections


---


## Visualising the basis

For the first figure, we want to explain what the basis is, and how the datasets distribute across the different components. We'll use projections from independent datasets to point at which traits were significant for each component.

```{r}

# Select independent datasets to extract the stars. Note that IgA Nephropathy, LADA, and PBC didn't have any independent signficant dataset available
independent <- c("CD_Liu_26192919_1", "K11_PSC_COLITIS_FinnGen_FinnGenR5_1", "UC_Liu_26192919_1", "SLE_Julia_29848360_1", "20002_1456_PanUKBB_PanUKBBR1_1", "MS_IMSGC_31604244_1", "20002_1111_Neale_UKBB_1", "20002_1661_PanUKBB_PanUKBBR1_1", "M13_RHEUMA_FinnGen_FinnGenR5_1", "T1D_Chiou_34012112_1", "ph571.6_PanUKBB_PanUKBBR1_1")
guide <- c("CD", "PSC", "UC", "SLE", "CEL", "MS", "Asthma", "VIT", "RA", "T1D", "PBC")

PT.basistraits <- proj.table[1:169] #  Same as PT.basis, but without stars and with original colnames (easier).

PT.ind <- PT.sig[Trait %in% independent]
for (x in 1:11){
  PT.ind$Trait <- str_replace(PT.ind$Trait, independent[x], guide[x])
} 

PT.ind <- PT.ind[, c("Trait", "PC", "stars")]
proj.basis <- merge.data.table(PT.basistraits, PT.ind, all.x = TRUE)
proj.basis[is.na(stars), stars:=""]


hmcol <-  colorRampPalette(c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"))(100)
PCorder <-  c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13")


M.sig <- acast(proj.basis[,c("PC", "Trait", "Delta")], PC ~ Trait) # PC, Trait, and Delta columns only
M.sig.stars <- acast(proj.basis[,c("PC","Trait","stars")], PC ~ Trait)
M.sig <- M.sig[PCorder,]
M.sig.stars <- M.sig.stars[PCorder,]
range <- max(abs(M.sig))
bp <- pheatmap(M.sig, breaks = seq(-range, range, length.out =100), cluster_cols = TRUE, cluster_rows = FALSE, display_numbers = M.sig.stars, treeheight_col = 15, fontsize_row = 12, fontsize_col = 12,cellwidth = 15, cellheight = 15, fontsize_number = 14,  color = rev(hmcol), legend = T)
bp
```


Save the heatmap.

```{r eval=FALSE}
# ggsave(file="../figures/202111_Nov21/Basis_heatmap_r.svg", plot=bp, width=18, height=18)   # ggsave doesn't export heatmap to svg correctly, so we need the workaround below.

save_pheatmap_png(bp, filename = "../figures/202201_Jan22/Basis_heatmap_r.png", width = 1500, height = 1500)
save_pheatmap_svg(bp, filename = "../figures/202201_Jan22/Basis_heatmap_r.svg", width = 8, height = 8)

```

Now for the myositis heatmap. We can join them together using Inkscape, for example.

```{r fig.height=5}
PT.myo <- PT.filt[First_Author %in% c("Miller", "Rothwell")]

# Adjust labels
PT.myo[, Label:=Trait_long][grepl("IIM", Trait_long), Label:="Myositis"][, Label:=paste0(Label, " / ", First_Author)]

M.myo <- acast(PT.myo[,c("PC", "Label", "Delta")], PC ~ Label) # PC, Trait, and Delta columns only
M.myo.stars <- acast(PT.myo[,c("PC","Label","stars")], PC ~ Label)
M.myo <- M.myo[PCorder,]
M.myo.stars <- M.myo.stars[PCorder,]
range <- max(abs(M.myo))
my <- pheatmap(M.myo, breaks = seq(-range, range, length.out =100), cluster_cols = TRUE, cluster_rows = FALSE, display_numbers = M.myo.stars, treeheight_col = 15, fontsize_row = 12, fontsize_col = 12,cellwidth = 15, cellheight = 15, fontsize_number = 14,  color = rev(hmcol), legend = T)
my
```


Save the heatmap

```{r eval = FALSE}
save_pheatmap_png(my, filename = "../figures/202201_Jan22/Myo_heatmap_r.png", width = 1500, height = 1500)
save_pheatmap_svg(my, filename = "../figures/202201_Jan22/Myo_heatmap_r.svg", width = 8, height = 8)

```


## Ladder plots with cluster traits

We carefully selected a number of immune conditions for clustering together with Miller's myositis datasets.

To see our datasets in context, we'll make ladder plots for the crucial PCs (1, 2, 3, 8, 9, 12, and 13)

```{r warning=FALSE}

data.sel <- readRDS("../data/Kath_clustering_data_v3.RDS")

PT.sel <- PT.filt[Trait %in% data.sel$Trait]
PT.sel <- make.labels(PT.sel)

PT.myo <- PT.sel[First_Author %in% c("Miller", "Rothwell")]  # Extract Miller and Rothwell to be added later, this is similar to the previous PT.myo, but without IBM
PT.sel <- PT.sel[!First_Author %in% c("Miller", "Rothwell")] # Remove it to avoid repetitions
PT.delta <- PT.sel[stars != ""] # Significant projections at FDR 5%.
PT.delta <- rbindlist(list(PT.basis, PT.delta, PT.myo),fill = TRUE) # Merge everything
PT.delta[, Var.Delta:=as.numeric(Var.Delta)]
PT.delta[Var.Delta != 0, ci:=sqrt(Var.Delta) * 1.96][is.na(ci),ci:=0] 
PCs <- unique(PT.delta$PC)

forest.plots <- lapply(setNames(PCs, PCs), function(x){
  dt <- PT.delta[PC == x,][order(Delta, decreasing = TRUE),][,colours:=ifelse(ci != 0, "black", "red")][First_Author %in% c("Miller", "Rothwell"), colours:="darkgreen"]
  fplot <- ggplot(dt, aes(x = reorder(Label, -Delta), y = Delta, ymin=Delta-ci, ymax=Delta+ci, colour = colours))+
    geom_pointrange()+
    scale_colour_manual(values = c("red" = "red", "black" = "black", "darkgreen" = "darkgreen"))+
    geom_hline(yintercept = 0, col="red", lty=2)+
    coord_flip()+
    xlab("Traits")+
    ylab("Delta")+
    ggtitle(paste("Ladder Plot ", x, sep = ""))+
    theme_minimal()+
    theme(axis.text.y = element_text(colour = dt$colours), legend.position = "none")
  fplot
})

```

```{r fig.height=8}
forest.plots[["PC1"]]
```

```{r fig.height=8}
forest.plots[["PC2"]]
```

```{r fig.height=8}
forest.plots[["PC3"]]
```

```{r fig.height=8}
forest.plots[["PC8"]]
```

```{r fig.height=8}
forest.plots[["PC9"]]
```

```{r fig.height=8}
forest.plots[["PC12"]]
```

```{r fig.height=8}
forest.plots[["PC13"]]
```

Save the plots
```{r eval=FALSE}
ggsave("../figures/202201_Jan22/Ladder_plot_PC1.png", forest.plots[["PC1"]], units = "mm", width = 180, height = 220, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC2.png", forest.plots[["PC2"]], units = "mm", width = 180, height = 180, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC3.png", forest.plots[["PC3"]], units = "mm", width = 180, height = 220, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC8.png", forest.plots[["PC8"]], units = "mm", width = 180, height = 160, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC9.png", forest.plots[["PC9"]], units = "mm", width = 180, height = 140, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC12.png", forest.plots[["PC12"]], units = "mm", width = 180, height = 180, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Ladder_plot_PC13.png", forest.plots[["PC13"]], units = "mm", width = 180, height = 260, dpi = 300, bg="white")
```



## Looking beyond selected traits

To enhance our vision beyond the selected clustered traits, we'll take a look at all traits that were significant. We'll also remove other redundant traits.

```{r fig.height=60, fig.width=10}
unwanted <- "Chen_32888493_6|ASTHMA_CHILD_EXMORE_FinnGen_FinnGenR5_1|L12_DERM_NAS_FinnGen_FinnGenR5_1|DM_RETINOPATHY_EXMORE|H7_RETINOPATHYDIAB|GRAVD_Okada_UP_[23]|K11_UC_STRICT2|H7_RETINOPATHYDIAB_PROLIF_|H7_MACULOPATHYDIAB_|DM_NEPHROPATHY_EXMORE_|G6_DISSOTH_FinnGen_FinnGenR5_1|L12_VITILIGO_FinnGen_FinnGenR5_1|OTHER_SYSTCON_FG|KELA_DIAB_INSUL_EXMORE_FinnGen_FinnGenR5_1" # Borrowed from IMD report. Updated with OTHER_SYSTCON_FG and KELA_DIAB_INSUL_EXMORE_FinnGen_FinnGenR5_1 for being redundant

PT.viz <- PT.sig[!grepl(unwanted, Trait),]
QC.viz <- QC.sig[Trait %in% unique(PT.viz$Trait)]

# 693 traits is a lot! Let's remove more and see

unwanted.fine <- "SLE_FG_FinnGen_FinnGenR5_1|L12_BULLOUS_FinnGen_FinnGenR5_1|GOUT_STRICT_FinnGen_FinnGenR5_1|D3_PURPURA_AND3_OTHER_HAEMORRHAGIC_FinnGen_FinnGenR5_1|SSC_LopezIsac_31672989_1|E4_DM1NASCOMP_FinnGen_FinnGenR5_1|I9_HEARTFAIL_AND_ANTIHYPERT_FinnGen_FinnGenR5_1|FG_CVD_FinnGen_FinnGenR5_1|I9_CHD_FinnGen_FinnGenR5_1|I9_CORATHER_FinnGen_FinnGenR5_1|I9_IHD_FinnGen_FinnGenR5_1|I9_ISCHHEART_FinnGen_FinnGenR5_1|I9_ANGINA_EXNONE_FinnGen_FinnGenR5_1|I9_ANGINA_FinnGen_FinnGenR5_1|	MYELOPROF_NONCML_FinnGen_FinnGenR5_1|ASTHMA_NOS_EXMORE_FinnGen_FinnGenR5_1|ALLERG_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|NONALLERG_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|ASTHMA_NONALLERG_FinnGen_FinnGenR5_1|ASTHMA_ACUTE_RESPIRATORY_INFECTIONS_FinnGen_FinnGenR5_1|ASTHMA_HOSPITAL_MAIN_FinnGen_FinnGenR5_1|J10_ASTHMA_INCLAVO_FinnGen_FinnGenR5_1|J10_ASTHMA_MAIN_EXMORE_FinnGen_FinnGenR5_1|J10_ASTHMA_MAIN_FinnGen_FinnGenR5_1|J10_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|ASTHMA_NAS_FinnGen_FinnGenR5_1|ASTHMA_ALLERG_EXMORE_FinnGen_FinnGenR5_1|ATOPIC_STRICT_FinnGen_FinnGenR5_1|ATOPIC_STRICT_REIMB_FinnGen_FinnGenR5_1|ASTHMA_PNEUMONIA_FinnGen_FinnGenR5_1|E4_HYTHYNAS_FinnGen_FinnGenR5_1|E4_HYTHY_AI_STRICT_PURCH_FinnGen_FinnGenR5_1|HYPOTHY_LEVOTHY_FinnGen_FinnGenR5_1|HYPOTHY_PURCHASE_FinnGen_FinnGenR5_1|HYPOTHY_REIMB_FinnGen_FinnGenR5_1|E4_DM1NOCOMP_FinnGen_FinnGenR5_1|T1D_WIDE1_FinnGen_FinnGenR5_1|T1D_WIDE_FinnGen_FinnGenR5_1|K11_REIMB_202_FinnGen_FinnGenR5_1|M13_JUVEARTH_FinnGen_FinnGenR5_1|D3_ANAEMIANAS_FinnGen_FinnGenR5_1|D3_OTHERANAEMIA_FinnGen_FinnGenR5_1|I9_REVACS_EXNONE_FinnGen_FinnGenR5_1|I9_REVASC_EXNONE_FinnGen_FinnGenR5_1|I9_CABG_EXNONE_FinnGen_FinnGenR5_1|MYELOPROF_NONCML_FinnGen_FinnGenR5_1|T1D_FinnGen_FinnGenR5_1|E4_DM1COMA|E4_DM1KETO|E4_DM1NEU|E4_DM1OPTH|E4_DM1PERIPH|E4_DM1REN|ASTHMA_MIXED|APPENDACUT_NOCOMPLIC|APPENDICITIS_BROAD_|K11_PSC_COLITIS_FinnGen_FinnGenR5_1|K11_CD_STRICT|CHRONNAS|CHRONOTH|DERMATOPOLY_FG_FinnGen_FinnGenR5_1|DM_MACULOPATHY_EXMORE|ULCERNAS|T1D_STRICT1|20002_1234_Neale_UKBB_1|20002_1374_Neale_UKBB_1|20002_1459_Neale_UKBB_1"
# Ferreira_19853236|Kanai|Chen_32888493_[1-4]|Vuckovic| removed from this list

PT.redviz <- PT.viz[!grepl(unwanted.fine,Trait)]
QC.redviz <- QC.viz[Trait %in% unique(PT.redviz$Trait),]

# 640 traits. Still a lot, but let's move forward with this

PT.redviz <- make.labels(PT.redviz)

nosigPC <- PT.redviz[, all(stars == ""), by=Trait] %>% .[.$V1 , Trait] # Remove traits with no significant PCs if any.

PT.redviz <- PT.redviz[!Trait %in% nosigPC]
QC.redviz <- QC.viz[Trait %in% unique(PT.redviz$Trait),]

# 607 Traits now

M.red <- acast(PT.redviz[,c("PC", "Label", "Delta")], Label ~ PC) # PC, Trait, and Delta columns only
M.red.stars <- acast(PT.redviz[,c("PC","Label","stars")], Label ~ PC)
M.red <- M.red[,PCorder]
M.red.stars <- M.red.stars[,PCorder]
range <- max(abs(M.red))

# Datasets to bolden
myo <- grep("Miller|Rothwell", rownames(M.red), value = TRUE)

# Let's also annotate by type of trait
annviz <- data.frame(Trait_class = QC.redviz$Trait_class, row.names = unique(PT.redviz$Label)) # QC.redviz doesn't have "Label" column, but traits are in the same order
colannviz = list(Trait_class = c(BMK = "#06D6A0", IMD = "#EF476F", INF = "#FFD166", CAN = "#F9DAD0", OTH ="#26547c", PSD="#818AA3"))

hmred <- pheatmap(M.red, breaks = seq(-range, range, length.out = 100), cluster_cols = FALSE, display_numbers = M.red.stars, fontsize_row = 8, fontsize_number = 11, color = rev(hmcol), labels_row = make_bold_names(M.red, rownames, myo), annotation_row = annviz, annotation_colors = colannviz)
```

Save it

```{r eval= FALSE}
save_pheatmap_png(hmred, filename = "../figures/202201_Jan22/Redvizsig_heatmap_v1.png", width = 1500, height = 9000)
```

Now for the forest plots. 

Now we can afford being a bit more stringent, so we'll plot only datasets significant at FDR 1% in each component

```{r warning=FALSE}

PT.delta <- PT.redviz[FDR.PC < 0.01 & !First_Author %in% c("Miller", "Rothwell") ] # Significant projections at FDR 1%. We remove the significant Rothwell/Miller to avoid repetitions
PT.delta <- rbindlist(list(PT.basis, PT.myo, PT.delta),fill = TRUE) # Merge everything, including PT.myo
PT.delta <- unique(PT.delta)
PT.delta[, Var.Delta:=as.numeric(Var.Delta)]
PT.delta[Var.Delta != 0, ci:=sqrt(Var.Delta) * 1.96][is.na(ci),ci:=0][,colours:=ifelse(ci != 0, "black", "red")][First_Author %in% c("Miller", "Rothwell"), colours:="darkgreen"]
PCs <- unique(PT.delta$PC)

forest.plots <- lapply(setNames(PCs, PCs), function(x){
  dt <- PT.delta[PC == x,][, Label:=reorder(Label, -Delta)]
  fplot <- ggplot(dt, aes(x = Label, y = Delta, ymin=Delta-ci, ymax=Delta+ci, colour = colours))+
    geom_pointrange()+
    scale_colour_manual(values = c("red" = "red", "black" = "black", "darkgreen" = "darkgreen"))+
    geom_hline(yintercept = 0, col="red", lty=2)+
    coord_flip()+
    xlab("Traits")+
    ylab("Delta")+
    ggtitle(paste("Ladder Plot ", x, sep = ""))+
    theme_minimal()+
    theme(axis.text.y = element_text(colour = dt[order(Delta, decreasing = TRUE)]$colours), legend.position = "none")
  fplot
})

```

```{r fig.height=30}
forest.plots[["PC1"]]
```

```{r fig.height=18}
forest.plots[["PC2"]]
```

```{r fig.height=33}
forest.plots[["PC3"]]
```

```{r fig.height=18}
forest.plots[["PC8"]]
```

```{r fig.height=14}
forest.plots[["PC9"]]
```

```{r fig.height=24}
forest.plots[["PC12"]]
```

```{r fig.height=40}
forest.plots[["PC13"]]
```




Save the plots
```{r eval=FALSE}
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC1.png", forest.plots[["PC1"]], units = "mm", width = 300, height = 900, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC2.png", forest.plots[["PC2"]], units = "mm", width = 300, height = 500, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC3.png", forest.plots[["PC3"]], units = "mm", width = 300, height = 900, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC8.png", forest.plots[["PC8"]], units = "mm", width = 300, height = 450, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC9.png", forest.plots[["PC9"]], units = "mm", width = 300, height = 300, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC12.png", forest.plots[["PC12"]], units = "mm", width = 300, height = 550, dpi = 300, bg="white")
ggsave("../figures/202201_Jan22/Redviz_Ladder_plot_PC13.png", forest.plots[["PC13"]], units = "mm", width = 300, height = 1000, dpi = 300, bg="white")
```




<!-- ```{r} -->

<!-- # Removing datasets for better visualisation -->
<!-- # unwanted <- "FinnGenR2|UKBB|Astle|Chen_32888493_6|ASTHMA_CHILD_EXMORE_FinnGen_FinnGenR3_1|EOSC_Chen_32888493_3" -->
<!-- #Ferreira_19853236|Kanai|Chen_32888493_[1-4,6]| -->
<!-- unwanted <- "Chen_32888493_6|ASTHMA_CHILD_EXMORE_FinnGen_FinnGenR5_1|L12_DERM_NAS_FinnGen_FinnGenR5_1|DM_RETINOPATHY_EXMORE|H7_RETINOPATHYDIAB|GRAVD_Okada_UP_[23]|K11_UC_STRICT2|H7_RETINOPATHYDIAB_PROLIF_|H7_MACULOPATHYDIAB_|DM_NEPHROPATHY_EXMORE_|PanUKBB|E4_HYPOGLYC_FinnGen_FinnGenR5_1|E4_GLUCOPANCREAS_FinnGen_FinnGenR5_1|E4_DM2OPTH_FinnGen_FinnGenR5_1|M13_OSTEOMYELITIS_FinnGen_FinnGenR5_1|RA_Kubo_BBJ_1|RA_Ishigaki_doi101101795948_1|20002_1276_Neale_UKBB_1|K11_FIBROCHIRLIV_FinnGen_FinnGenR5_1|N14_GLOMEINOTH_FinnGen_FinnGenR5_1|K11_LIP_ORAL_MUCOSA_FinnGen_FinnGenR5_1|TONS_Tian_28928442_1|RX_ANTIHYP_FinnGen_FinnGenR5_1|M13_MUSCULOSKELETAL_FinnGen_FinnGenR5_1|K11_OTHDIG_FinnGen_FinnGenR5_1|TG_Sakaue_doi1011012020102320213652_1|CEI_Tian_28928442_1|TPROT_Sakaue_doi1011012020102320213652_1|NEUC_Sakaue_doi1011012020102320213652_1|RA_Sakaue_doi1011012020102320213652_1|G6_DISSOTH_FinnGen_FinnGenR5_1|L12_VITILIGO_FinnGen_FinnGenR5_1" # Here we'll add the datasets we don't want to visualise at all because they're problematic for some reason (see below) -->
<!-- # For IMD we added DM_RETINOPATHY_EXMORE|H7_RETINOPATHYDIAB|GRAVD_Okada_UP_[23]|K11_UC_STRICT2|H7_RETINOPATHYDIAB_PROLIF_|H7_MACULOPATHYDIAB_|DM_NEPHROPATHY_EXMORE_, since they're redundant in name with other significant datasets. -->
<!-- # We also remove PanUKBB from visualisation, for now, since they're over 180 datasets -->
<!-- # We remove E4_HYPOGLYC_FinnGen_FinnGenR5_1, 	E4_GLUCOPANCREAS_FinnGen_FinnGenR5_1, E4_DM2OPTH_FinnGen_FinnGenR5_1, M13_OSTEOMYELITIS_FinnGen_FinnGenR5_1, RA_Kubo_BBJ_1, RA_Ishigaki_doi101101795948_1, 20002_1276_Neale_UKBB_1, K11_FIBROCHIRLIV_FinnGen_FinnGenR5_1, N14_GLOMEINOTH_FinnGen_FinnGenR5_1, K11_LIP_ORAL_MUCOSA_FinnGen_FinnGenR5_1, TONS_Tian_28928442_1, RX_ANTIHYP_FinnGen_FinnGenR5_1, M13_MUSCULOSKELETAL_FinnGen_FinnGenR5_1, K11_OTHDIG_FinnGen_FinnGenR5_1, TG_Sakaue_doi1011012020102320213652_1, CEI_Tian_28928442_1, TPROT_Sakaue_doi1011012020102320213652_1, NEUC_Sakaue_doi1011012020102320213652_1, RA_Sakaue_doi1011012020102320213652_1, G6_DISSOTH_FinnGen_FinnGenR5_1, and L12_VITILIGO_FinnGen_FinnGenR5_1 because they had no significant PCs. -->

<!-- # This monstruous line will more or less accurately define a Label variable that will help us visualise  datasets more easily -->
<!-- # Basically, we -->
<!-- # (1) Remove unwanted files -->
<!-- # (2) Use the full trait definition + Author + Population. -->
<!-- # (3) Use only full trait for FinnGenR3, since "FinnGen" is defined in Trait_long -->
<!-- # (4) Don't expand cytokines -->


<!-- PT.sigviz <- PT.sig[!grepl(unwanted, Trait),][,Label:=str_trunc(paste0( Trait_long, " (",First_Author,") ", Population), width = 65)][,Label:=ifelse(grepl("FinnGen", Label), Trait_long, Label)][,Label:=ifelse(grepl("GOUT_FinnGen", Trait), "Gout (FinnGen)", Label)][,Label:=ifelse(grepl("Interleukin|TRAIL|VEGF|PDGF|CXCL1|MIP1a|MIG", Label), paste0(Trait_ID_2.0, " levels (",First_Author, ") ", Population), Label)] -->
<!-- #[, Label:=gsub("ILD", "Interstitial Lung Disease (ILD)", Label)] -->
<!-- # For IMD, we added MIG in the list of expanded cytokines -->

<!-- QC.sigviz <- QC.sig[Trait %in% unique(PT.sigviz$Trait),] -->
<!-- nrow(QC.sigviz) -->

<!-- # This is a finer remover, as we'll remove datasets that are perfectly fine but are redundant so we remove them to diminish cluttering.  -->
<!-- unwanted.fine <- "SLE_FG_FinnGen_FinnGenR5_1|L12_BULLOUS_FinnGen_FinnGenR5_1|GOUT_STRICT_FinnGen_FinnGenR5_1|D3_PURPURA_AND3_OTHER_HAEMORRHAGIC_FinnGen_FinnGenR5_1|SSC_LopezIsac_31672989_1|E4_DM1NASCOMP_FinnGen_FinnGenR5_1|I9_HEARTFAIL_AND_ANTIHYPERT_FinnGen_FinnGenR5_1|FG_CVD_FinnGen_FinnGenR5_1|I9_CHD_FinnGen_FinnGenR5_1|I9_CORATHER_FinnGen_FinnGenR5_1|I9_IHD_FinnGen_FinnGenR5_1|I9_ISCHHEART_FinnGen_FinnGenR5_1|I9_ANGINA_EXNONE_FinnGen_FinnGenR5_1|I9_ANGINA_FinnGen_FinnGenR5_1|	 -->
<!-- MYELOPROF_NONCML_FinnGen_FinnGenR5_1|ASTHMA_NOS_EXMORE_FinnGen_FinnGenR5_1|ALLERG_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|NONALLERG_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|ASTHMA_NONALLERG_FinnGen_FinnGenR5_1|ASTHMA_ACUTE_RESPIRATORY_INFECTIONS_FinnGen_FinnGenR5_1|ASTHMA_HOSPITAL_MAIN_FinnGen_FinnGenR5_1|J10_ASTHMA_INCLAVO_FinnGen_FinnGenR5_1|J10_ASTHMA_MAIN_EXMORE_FinnGen_FinnGenR5_1|J10_ASTHMA_MAIN_FinnGen_FinnGenR5_1|J10_ASTHMA_EXMORE_FinnGen_FinnGenR5_1|ASTHMA_NAS_FinnGen_FinnGenR5_1|ASTHMA_ALLERG_EXMORE_FinnGen_FinnGenR5_1|ATOPIC_STRICT_FinnGen_FinnGenR5_1|ATOPIC_STRICT_REIMB_FinnGen_FinnGenR5_1|ASTHMA_PNEUMONIA_FinnGen_FinnGenR5_1|E4_HYTHYNAS_FinnGen_FinnGenR5_1|E4_HYTHY_AI_STRICT_PURCH_FinnGen_FinnGenR5_1|HYPOTHY_LEVOTHY_FinnGen_FinnGenR5_1|HYPOTHY_PURCHASE_FinnGen_FinnGenR5_1|HYPOTHY_REIMB_FinnGen_FinnGenR5_1|E4_DM1NOCOMP_FinnGen_FinnGenR5_1|T1D_WIDE1_FinnGen_FinnGenR5_1|T1D_WIDE_FinnGen_FinnGenR5_1|K11_REIMB_202_FinnGen_FinnGenR5_1|M13_JUVEARTH_FinnGen_FinnGenR5_1|D3_ANAEMIANAS_FinnGen_FinnGenR5_1|D3_OTHERANAEMIA_FinnGen_FinnGenR5_1|I9_REVACS_EXNONE_FinnGen_FinnGenR5_1|I9_REVASC_EXNONE_FinnGen_FinnGenR5_1|I9_CABG_EXNONE_FinnGen_FinnGenR5_1|MYELOPROF_NONCML_FinnGen_FinnGenR5_1" -->
<!-- # Ferreira_19853236|Kanai|Chen_32888493_[1-4]|Vuckovic| removed from this list -->

<!-- PT.redviz <- PT.sigviz[!grepl(unwanted.fine,Trait, perl = TRUE)] -->
<!-- QC.redviz <- QC.sig[Trait %in% unique(PT.redviz$Trait),] -->

<!-- ``` -->




